{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 90vh;">
  <div class="card shadow-lg" style="width: 28rem; border-radius: 20px;">
    <div class="card-body p-4">
      <h4 class="card-title text-center mb-4">üîê Random Password Generator</h4>

      <!-- Password Display -->
      <div class="mb-4">
        <label class="form-label fw-bold">Generated Password</label>
        <div id="pwdDisplay" class="p-3 rounded border" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Courier New', monospace; min-height: 60px; display: flex; align-items: center;">
          <strong id="generatedPassword" style="font-size: 1.1rem; color: #ffffff; word-break: break-all; width: 100%;">Click Generate to create password</strong>
        </div>
      </div>

      <!-- Password Strength & Entropy -->
      <div class="mb-3">
        <div class="d-flex justify-content-between mb-2">
          <small class="text-muted fw-bold">Strength: <span id="strengthLabel" class="badge bg-secondary">Unknown</span></small>
          <small class="text-muted fw-bold">Entropy: <span id="entropyBits" class="badge bg-info">0</span> bits</small>
        </div>
        <div class="progress mb-2" style="height: 12px;">
          <div id="strengthBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%"></div>
        </div>
      </div>

      <!-- Length Controls -->
      <div class="mb-3">
        <label for="lengthRange" class="form-label fw-bold">Password Length: <span id="lengthDisplay">16</span></label>
        <div class="d-flex gap-3 align-items-center">
          <input id="lengthRange" type="range" min="6" max="64" value="16" class="form-range flex-grow-1" oninput="syncLength(this.value)">
          <input id="lengthInput" type="number" min="6" max="64" value="16" class="form-control" style="width: 80px;" oninput="syncLength(this.value)">
        </div>
      </div>

      <!-- Character Options -->
      <div class="mb-3">
        <label class="form-label fw-bold">Include Characters</label>
        <div class="row">
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeLower" checked>
              <label class="form-check-label" for="includeLower">Lowercase (a-z)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeUpper" checked>
              <label class="form-check-label" for="includeUpper">Uppercase (A-Z)</label>
            </div>
          </div>
          <div class="col-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeNumbers" checked>
              <label class="form-check-label" for="includeNumbers">Numbers (0-9)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
              <label class="form-check-label" for="includeSymbols">Symbols (!@#$...)</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Options -->
      <div class="mb-4">
        <label class="form-label fw-bold">Advanced Options</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="excludeAmbiguous">
          <label class="form-check-label" for="excludeAmbiguous">Exclude ambiguous characters (Il1O0)</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="excludeBrackets">
          <label class="form-check-label" for="excludeBrackets">Exclude brackets ( () [] {} &lt;&gt; )</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="noRepeat">
          <label class="form-check-label" for="noRepeat">Avoid repeated characters</label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-grid gap-2">
        <button type="button" class="btn btn-primary btn-lg" onclick="generatePassword()">
          üé≤ Generate Password
        </button>
        <div class="row g-2">
          <div class="col-6">
            <button type="button" class="btn btn-outline-secondary w-100" onclick="regeneratePassword()">
              üîÑ Regenerate
            </button>
          </div>
          <div class="col-6">
            <button type="button" class="btn btn-success w-100" onclick="copyPassword()">
              üìã Copy Password
            </button>
          </div>
        </div>
        <button type="button" class="btn btn-outline-danger" onclick="clearPassword()">
          üóëÔ∏è Clear
        </button>
      </div>

      <!-- Back to Home -->
      <div class="text-center mt-4">
        <a href="{% url 'home' %}" class="btn btn-outline-primary">
          ‚Üê Back to Home
        </a>
      </div>

      <!-- Security Note -->
      <div class="mt-3">
        <small class="text-muted">
          <strong>üí° Security Tip:</strong> Use at least 12 characters with multiple character types for strong passwords. Generated passwords use cryptographically secure randomness.
        </small>
      </div>
    </div>
  </div>
</div>

<style>
#pwdDisplay {
  transition: all 0.3s ease;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.form-check-input:checked {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.btn {
  border-radius: 10px;
  font-weight: 500;
}

.progress {
  border-radius: 8px;
}

.badge {
  font-size: 0.8em;
}

@media (max-width: 576px) {
  .card {
    width: 95% !important;
    margin: 10px;
  }
  #pwdDisplay {
    font-size: 0.9rem;
  }
}
</style>

<script>
/* Secure Random Password Generator */
(function() {
  const LOWER = 'abcdefghijklmnopqrstuvwxyz';
  const UPPER = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const NUMS = '0123456789';
  const SYMS = '!@#$%^&*()-_=+[]{};:,.<>?/|`~';
  
  const AMBIG = /[Il1O0]/g;
  const BRACKETS = /[()\[\]{}<>]/g;

  let lastGenerated = null;

  function getRandomInt(max) {
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    return array[0] % max;
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = getRandomInt(i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  window.syncLength = function(val) {
    const v = Math.max(6, Math.min(64, Number(val) || 6));
    document.getElementById('lengthRange').value = v;
    document.getElementById('lengthInput').value = v;
    document.getElementById('lengthDisplay').textContent = v;
  };

  function buildCharacterPool(options) {
    let pool = '';
    if (options.lower) pool += LOWER;
    if (options.upper) pool += UPPER;
    if (options.nums) pool += NUMS;
    if (options.syms) pool += SYMS;
    
    if (options.excludeAmbiguous) pool = pool.replace(AMBIG, '');
    if (options.excludeBrackets) pool = pool.replace(BRACKETS, '');
    
    return pool.split('');
  }

  function calculateEntropy(length, poolSize) {
    if (poolSize <= 0) return 0;
    return +(length * Math.log2(poolSize)).toFixed(1);
  }

  function getStrengthInfo(bits) {
    if (bits < 28) return { label: 'Weak', percent: 25, color: 'bg-danger' };
    if (bits < 36) return { label: 'Fair', percent: 50, color: 'bg-warning' };
    if (bits < 60) return { label: 'Good', percent: 75, color: 'bg-info' };
    return { label: 'Strong', percent: 100, color: 'bg-success' };
  }

  function updateDisplay(password, entropy) {
    const passwordEl = document.getElementById('generatedPassword');
    const entropyEl = document.getElementById('entropyBits');
    const strengthLabelEl = document.getElementById('strengthLabel');
    const strengthBarEl = document.getElementById('strengthBar');
    const displayEl = document.getElementById('pwdDisplay');

    passwordEl.textContent = password;
    entropyEl.textContent = entropy;

    const strength = getStrengthInfo(entropy);
    strengthLabelEl.textContent = strength.label;
    strengthLabelEl.className = `badge bg-${strength.label.toLowerCase() === 'weak' ? 'danger' : 
      strength.label.toLowerCase() === 'fair' ? 'warning' : 
      strength.label.toLowerCase() === 'good' ? 'info' : 'success'}`;

    strengthBarEl.className = `progress-bar progress-bar-striped ${strength.color}`;
    strengthBarEl.style.width = strength.percent + '%';

    // Update display styling
    if (password && password !== 'Click Generate to create password') {
      displayEl.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
      passwordEl.style.color = '#ffffff';
    } else {
      displayEl.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      passwordEl.style.color = '#ffffff';
    }
  }

  window.generatePassword = function() {
    const length = Number(document.getElementById('lengthInput').value) || 16;
    const options = {
      lower: document.getElementById('includeLower').checked,
      upper: document.getElementById('includeUpper').checked,
      nums: document.getElementById('includeNumbers').checked,
      syms: document.getElementById('includeSymbols').checked,
      excludeAmbiguous: document.getElementById('excludeAmbiguous').checked,
      excludeBrackets: document.getElementById('excludeBrackets').checked,
      noRepeat: document.getElementById('noRepeat').checked
    };

    const pool = buildCharacterPool(options);
    
    if (pool.length === 0) {
      updateDisplay('Error: Select at least one character type', 0);
      return;
    }

    if (options.noRepeat && pool.length < length) {
      updateDisplay('Error: Not enough unique characters for length', 0);
      return;
    }

    let passwordChars = [];
    
    // Ensure at least one character from each selected type
    const requiredSets = [];
    if (options.lower) requiredSets.push(LOWER.replace(AMBIG, '').replace(BRACKETS, ''));
    if (options.upper) requiredSets.push(UPPER.replace(AMBIG, '').replace(BRACKETS, ''));
    if (options.nums) requiredSets.push(NUMS);
    if (options.syms) requiredSets.push(SYMS.replace(AMBIG, '').replace(BRACKETS, ''));

    // Add one character from each required set
    requiredSets.forEach(setStr => {
      const setChars = setStr.split('').filter(char => pool.includes(char));
      if (setChars.length > 0) {
        passwordChars.push(setChars[getRandomInt(setChars.length)]);
      }
    });

    // Fill remaining length
    const poolCopy = options.noRepeat ? pool.slice() : pool;
    const remaining = length - passwordChars.length;

    for (let i = 0; i < remaining; i++) {
      if (options.noRepeat) {
        // Remove used characters from pool
        passwordChars.forEach(usedChar => {
          const index = poolCopy.indexOf(usedChar);
          if (index > -1) poolCopy.splice(index, 1);
        });
        
        if (poolCopy.length === 0) break;
        const randomIndex = getRandomInt(poolCopy.length);
        passwordChars.push(poolCopy.splice(randomIndex, 1)[0]);
      } else {
        passwordChars.push(pool[getRandomInt(pool.length)]);
      }
    }

    // Shuffle the password
    shuffleArray(passwordChars);
    const password = passwordChars.join('');
    
    const entropy = calculateEntropy(length, pool.length);
    updateDisplay(password, entropy);
    
    lastGenerated = { password, options, length };
  };

  window.regeneratePassword = function() {
    if (!lastGenerated) {
      generatePassword();
      return;
    }
    
    // Restore last settings
    document.getElementById('lengthInput').value = lastGenerated.length;
    document.getElementById('lengthRange').value = lastGenerated.length;
    document.getElementById('lengthDisplay').textContent = lastGenerated.length;
    document.getElementById('includeLower').checked = lastGenerated.options.lower;
    document.getElementById('includeUpper').checked = lastGenerated.options.upper;
    document.getElementById('includeNumbers').checked = lastGenerated.options.nums;
    document.getElementById('includeSymbols').checked = lastGenerated.options.syms;
    document.getElementById('excludeAmbiguous').checked = lastGenerated.options.excludeAmbiguous;
    document.getElementById('excludeBrackets').checked = lastGenerated.options.excludeBrackets;
    document.getElementById('noRepeat').checked = lastGenerated.options.noRepeat;
    
    generatePassword();
  };

  window.copyPassword = async function() {
    const password = document.getElementById('generatedPassword').textContent;
    if (!password || password === 'Click Generate to create password') {
      alert('No password to copy. Generate one first!');
      return;
    }

    try {
      await navigator.clipboard.writeText(password);
      
      // Visual feedback
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úÖ Copied!';
      btn.classList.add('btn-success');
      btn.classList.remove('btn-success');
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
        btn.classList.add('btn-success');
      }, 1500);
      
    } catch (err) {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = password;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('Password copied to clipboard!');
    }
  };

  window.clearPassword = function() {
    updateDisplay('Click Generate to create password', 0);
    document.getElementById('strengthLabel').textContent = 'Unknown';
    document.getElementById('strengthLabel').className = 'badge bg-secondary';
    document.getElementById('strengthBar').style.width = '0%';
    lastGenerated = null;
  };

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    syncLength(16);
    clearPassword();
  });

})();
</script>
{% endblock %}