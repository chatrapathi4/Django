{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-3 py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
      
      <!-- Header Section -->
      <div class="text-center mb-4">
        <h2 class="display-5 fw-bold text-gradient mb-2">Random Meme Generator</h2>
        <p class="text-muted fs-5">Discover hilarious content from Reddit's finest communities</p>
      </div>

      <!-- Main Content Card -->
      <div class="card shadow-lg border-0 main-card">
        <div class="card-body p-4">
          
          <!-- Meme Display Area -->
          <div class="row mb-4">
            <div class="col-12">
              <div id="memeContainer" class="meme-display position-relative">
                <div id="loadingText" class="loading-content">
                  <div class="spinner-container">
                    <div class="custom-spinner"></div>
                  </div>
                  <h5 class="loading-title">Ready to Generate!</h5>
                  <p class="loading-subtitle">Click the button below to fetch a hilarious meme</p>
                </div>
                <img id="memeImage" class="meme-image" alt="Random Meme">
              </div>
            </div>
          </div>

          <!-- Meme Information Panel -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="info-panel">
                <div class="row align-items-center">
                  <div class="col-sm-6 mb-2 mb-sm-0">
                    <div class="d-flex align-items-center gap-3">
                      <span class="info-badge subreddit-badge">
                        <i class="fas fa-reddit-alien me-1"></i>
                        <span id="subredditName">â€”</span>
                      </span>
                      <span class="info-badge score-badge">
                        <i class="fas fa-arrow-up me-1"></i>
                        <span id="memeScore">â€”</span>
                      </span>
                    </div>
                  </div>
                  <div class="col-sm-6 text-sm-end">
                    <div class="stats-display">
                      <small class="text-muted">
                        Generated: <span id="memeCount" class="fw-bold text-primary">0</span> | 
                        Laughs: <span id="laughCount" class="fw-bold text-success">0</span>
                      </small>
                      <button type="button" class="btn btn-outline-danger btn-sm ms-2" onclick="resetStats()" title="Reset Statistics">
                        <i class="fas fa-undo me-1"></i>Reset Stats
                      </button>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="meme-title-container">
                      <h6 class="text-muted mb-1">Title:</h6>
                      <p id="memeTitle" class="meme-title">Click generate to see a meme!</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Controls Section -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="controls-section">
                <label class="form-label fw-semibold mb-3">
                  <i class="fas fa-filter me-2"></i>Choose Meme Source
                </label>
                <select id="memeSource" class="form-select custom-select">
                  <option value="random">ðŸŽ² Random (All Sources)</option>
                  <option value="memes">r/memes</option>
                  <option value="dankmemes">r/dankmemes</option>
                  <option value="memeeconomy">r/MemeEconomy</option>
                  <option value="wholesomememes">r/wholesomememes</option>
                  <option value="programmerhumor">r/ProgrammerHumor</option>
                  <option value="historymemes">r/HistoryMemes</option>
                  <option value="prequelmemes">r/PrequelMemes</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row">
            <div class="col-12">
              <div class="button-grid">
                <!-- Primary Generate Button -->
                <button type="button" class="btn btn-primary btn-lg generate-btn" onclick="generateMeme()">
                  <i class="fas fa-magic me-2"></i>Generate Meme
                </button>
                
                <!-- Secondary Actions -->
                <div class="secondary-buttons">
                  <button type="button" class="btn btn-outline-secondary action-btn" onclick="saveMeme()" id="saveBtn" disabled>
                    <i class="fas fa-download me-2"></i>Save
                  </button>
                  <button type="button" class="btn btn-outline-success action-btn" onclick="shareMeme()" id="shareBtn" disabled>
                    <i class="fas fa-share-alt me-2"></i>Share
                  </button>
                  <button type="button" class="btn btn-outline-warning action-btn" onclick="refreshMeme()">
                    <i class="fas fa-sync-alt me-2"></i>Random
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Navigation -->
          <div class="row mt-4">
            <div class="col-12 text-center">
              <a href="{% url 'home' %}" class="btn btn-outline-dark btn-sm back-btn">
                <i class="fas fa-arrow-left me-2"></i>Back to Home
              </a>
            </div>
          </div>

        </div>
      </div>

      <!-- Info Cards -->
      <div class="row mt-4">
        <div class="col-md-6 mb-3">
          <div class="card info-card border-0">
            <div class="card-body text-center">
              <i class="fas fa-shield-alt text-primary mb-2" style="font-size: 2rem;"></i>
              <h6 class="card-title">Safe Content</h6>
              <small class="text-muted">Memes are fetched from Reddit's public API with content filtering</small>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="card info-card border-0">
            <div class="card-body text-center">
              <i class="fas fa-rocket text-success mb-2" style="font-size: 2rem;"></i>
              <h6 class="card-title">Fast & Fresh</h6>
              <small class="text-muted">Real-time content from the most popular meme communities</small>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
/* Modern Styling for Meme Generator */
.text-gradient {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.main-card {
  border-radius: 20px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  overflow: hidden;
}

.dark-theme .main-card {
  background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
}

.meme-display {
  min-height: 400px;
  border-radius: 15px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.meme-display:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.loading-content {
  text-align: center;
  color: white;
  padding: 2rem;
}

.spinner-container {
  margin-bottom: 1.5rem;
}

.custom-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255,255,255,0.3);
  border-left: 4px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-title {
  font-weight: 600;
  margin-bottom: 0.5rem;
  font-size: 1.25rem;
}

.loading-subtitle {
  margin-bottom: 0;
  opacity: 0.9;
  font-size: 0.95rem;
}

.meme-image {
  display: none;
  max-width: 100%;
  max-height: 500px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.meme-image:hover {
  transform: scale(1.02);
}

.info-panel {
  background: rgba(255,255,255,0.9);
  border-radius: 12px;
  padding: 1.5rem;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
}

.dark-theme .info-panel {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
}

.info-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
  white-space: nowrap;
}

.subreddit-badge {
  background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
  color: white;
}

.score-badge {
  background: linear-gradient(135deg, #4ECDC4, #44A08D);
  color: white;
}

.meme-title {
  font-weight: 600;
  color: #2c3e50;
  line-height: 1.4;
  margin: 0;
}

.dark-theme .meme-title {
  color: #ecf0f1;
}

.controls-section {
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  padding: 1.5rem;
  backdrop-filter: blur(10px);
}

.dark-theme .controls-section {
  background: rgba(0,0,0,0.2);
}

.custom-select {
  border-radius: 10px;
  border: 2px solid transparent;
  background: white;
  padding: 0.75rem 1rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.custom-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  background: white;
}

.dark-theme .custom-select {
  background: #2c3e50;
  color: white;
  border-color: #34495e;
}

.button-grid {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.generate-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  border-radius: 12px;
  padding: 1rem 2rem;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.generate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.generate-btn:active {
  transform: translateY(0);
}

.secondary-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.75rem;
}

.action-btn {
  border-radius: 10px;
  padding: 0.75rem 1rem;
  font-weight: 500;
  transition: all 0.2s ease;
  border-width: 2px;
}

.action-btn:hover {
  transform: translateY(-1px);
}

.action-btn:disabled {
  opacity: 0.5;
  transform: none;
}

.back-btn {
  border-radius: 20px;
  padding: 0.5rem 1.5rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.info-card {
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  transition: transform 0.2s ease;
}

.info-card:hover {
  transform: translateY(-3px);
}

.dark-theme .info-card {
  background: rgba(0,0,0,0.2);
}

.stats-display {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0.5rem;
  flex-wrap: wrap;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
  .meme-display {
    min-height: 300px;
  }
  
  .info-panel {
    padding: 1rem;
  }
  
  .controls-section {
    padding: 1rem;
  }
  
  .secondary-buttons {
    grid-template-columns: 1fr;
  }
  
  .generate-btn {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
  }

  .stats-display {
    justify-content: center;
    text-align: center;
  }
}

@media (max-width: 576px) {
  .info-badge {
    font-size: 0.8rem;
    padding: 0.3rem 0.6rem;
  }
  
  .display-5 {
    font-size: 1.8rem;
  }

  .stats-display {
    flex-direction: column;
    align-items: center;
  }
}

/* Animation for meme loading */
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.meme-image[src] {
  animation: fadeIn 0.5s ease;
}

/* Success state styling */
.meme-display.loaded {
  background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
}

/* Error state styling */
.meme-display.error {
  background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
}

/* Reset button styling */
.btn-outline-danger.btn-sm {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 15px;
}
</style>

<script>
/* Enhanced Random Meme Generator with improved UX */
(function() {
  let currentMeme = null;
  let memeCount = parseInt(localStorage.getItem('memeCount') || '0');
  let laughCount = parseInt(localStorage.getItem('laughCount') || '0');

  function updateStats() {
    document.getElementById('memeCount').textContent = memeCount;
    document.getElementById('laughCount').textContent = laughCount;
    localStorage.setItem('memeCount', memeCount.toString());
    localStorage.setItem('laughCount', laughCount.toString());
  }

  function showLoading(show = true, message = 'Fetching hilarious content...') {
    const loading = document.getElementById('loadingText');
    const image = document.getElementById('memeImage');
    const container = document.getElementById('memeContainer');
    
    if (show) {
      loading.style.display = 'block';
      image.style.display = 'none';
      container.className = 'meme-display position-relative';
      loading.innerHTML = `
        <div class="spinner-container">
          <div class="custom-spinner"></div>
        </div>
        <h5 class="loading-title">${message}</h5>
        <p class="loading-subtitle">This might take a moment...</p>
      `;
    } else {
      loading.style.display = 'none';
      image.style.display = 'block';
      container.classList.add('loaded');
    }
  }

  function showError(message) {
    const loading = document.getElementById('loadingText');
    const container = document.getElementById('memeContainer');
    
    container.className = 'meme-display position-relative error';
    loading.style.display = 'block';
    loading.innerHTML = `
      <div class="text-center">
        <i class="fas fa-exclamation-triangle mb-3" style="font-size: 3rem;"></i>
        <h5 class="loading-title">Oops! Something went wrong</h5>
        <p class="loading-subtitle">${message}</p>
        <button class="btn btn-outline-light btn-sm mt-2" onclick="generateMeme()">
          <i class="fas fa-redo me-1"></i>Try Again
        </button>
      </div>
    `;
  }

  function updateMemeInfo(meme) {
    document.getElementById('subredditName').textContent = `r/${meme.subreddit}`;
    document.getElementById('memeScore').textContent = `${meme.score || 0}`;
    document.getElementById('memeTitle').textContent = meme.title || 'Untitled Meme';
    
    // Enable action buttons with animation
    const saveBtn = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');
    
    saveBtn.disabled = false;
    shareBtn.disabled = false;
    
    // Add a subtle bounce animation to enabled buttons
    setTimeout(() => {
      saveBtn.style.animation = 'bounce 0.6s ease';
      shareBtn.style.animation = 'bounce 0.6s ease';
    }, 300);
  }

  window.generateMeme = async function() {
    showLoading(true, 'Searching for the perfect meme...');
    
    try {
      const source = document.getElementById('memeSource').value;
      const response = await fetch(`/api/meme/?subreddit=${source}`);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `Server error: ${response.status}`);
      }
      
      const memeData = await response.json();
      const img = document.getElementById('memeImage');
      
      img.onload = function() {
        showLoading(false);
        updateMemeInfo(memeData);
        currentMeme = memeData;
        memeCount++;
        updateStats();
        
        // Add success animation
        this.style.animation = 'fadeIn 0.5s ease';
      };
      
      img.onerror = function() {
        console.error('Failed to load meme image');
        showError('Failed to load the meme image. Let\'s try another one!');
        setTimeout(() => generateMeme(), 2000);
      };

      img.src = memeData.url;

    } catch (error) {
      console.error('Error generating meme:', error);
      showError(error.message || 'Network error occurred');
    }
  };

  window.refreshMeme = function() {
    document.getElementById('memeSource').value = 'random';
    generateMeme();
  };

  window.saveMeme = async function() {
    if (!currentMeme) {
      showNotification('No meme to save! Generate one first.', 'warning');
      return;
    }

    try {
      const link = document.createElement('a');
      link.href = currentMeme.url;
      link.download = `meme_${Date.now()}.${currentMeme.url.split('.').pop().split('?')[0]}`;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showNotification('Meme saved successfully!', 'success');
      laughCount++;
      updateStats();

    } catch (error) {
      console.error('Error saving meme:', error);
      showNotification('Failed to save meme. Try right-clicking the image.', 'error');
    }
  };

  window.shareMeme = async function() {
    if (!currentMeme) {
      showNotification('No meme to share! Generate one first.', 'warning');
      return;
    }

    const shareData = {
      title: currentMeme.title,
      text: `Check out this meme from r/${currentMeme.subreddit}!`,
      url: currentMeme.permalink || currentMeme.url
    };

    try {
      if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        await navigator.share(shareData);
      } else {
        await navigator.clipboard.writeText(currentMeme.permalink || currentMeme.url);
        showNotification('Meme link copied to clipboard!', 'success');
      }

      laughCount++;
      updateStats();

    } catch (error) {
      console.error('Error sharing meme:', error);
      prompt('Share this meme:', currentMeme.permalink || currentMeme.url);
    }
  };

  window.resetStats = function() {
    if (confirm('Are you sure you want to reset all statistics? This action cannot be undone.')) {
      memeCount = 0;
      laughCount = 0;
      updateStats();
      showNotification('Statistics reset successfully!', 'success');
      
      // Add a little animation to the reset button
      const resetBtn = event.target;
      const originalContent = resetBtn.innerHTML;
      resetBtn.innerHTML = '<i class="fas fa-check me-1"></i>Reset!';
      resetBtn.classList.add('btn-success');
      resetBtn.classList.remove('btn-outline-danger');
      
      setTimeout(() => {
        resetBtn.innerHTML = originalContent;
        resetBtn.classList.remove('btn-success');
        resetBtn.classList.add('btn-outline-danger');
      }, 2000);
    }
  };

  function showNotification(message, type = 'info') {
    // Create a simple notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} notification`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Click on image to add laugh
  document.getElementById('memeImage').addEventListener('click', function() {
    if (currentMeme) {
      laughCount++;
      updateStats();
      
      // Fun click animation
      this.style.transform = 'scale(1.05)';
      setTimeout(() => {
        this.style.transform = 'scale(1)';
      }, 150);
      
      showNotification('Thanks for the laugh! ðŸ˜„', 'success');
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateStats();
  });

  // Add CSS for notifications
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-3px); }
      60% { transform: translateY(-2px); }
    }
  `;
  document.head.appendChild(style);

})();
</script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}